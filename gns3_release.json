{
   "variables" : {
      "ssh_pass" : "gns3",
      "ssh_name" : "gns3",
      "gns3_version": "{{env `GNS3_VERSION`}}",
      "gns3_release_channel": "{{env `GNS3_RELEASE_CHANNEL`}}",
      "gns3_src": "{{env `GNS3_SRC`}}",
      "iso_checksum_type": "sha256",
      "iso_checksum": "b8f31413336b9393ad5d8ef0282717b2ab19f007df2e9ed5196c13d8f9153c8b",
      "iso_url": "https://releases.ubuntu.com/20.04/ubuntu-20.04.6-live-server-amd64.iso"
   },
   "provisioners" : [
      {
        "inline": "sudo rm -rf /tmp/*",
        "type": "shell"
      },
      {
        "inline": "echo -n \"{{user `gns3_release_channel`}}\" > /home/gns3/.config/GNS3/gns3_release_channel",
        "type": "shell"
      },
      {
         "destination" : "/tmp/gns3welcome.py",
         "type" : "file",
         "source" : "scripts/welcome.py"
      },
      {
         "type" : "shell",
         "script" : "scripts/provision_gns3.sh",
          "environment_vars": [
            "GNS3_VERSION={{user `gns3_version`}}"
          ]
      }
   ],
   "builders" : [
      {
          "type": "vmware-vmx",
          "vm_name" : "GNS3 VM",
          "headless": true,
          "source_path": "{{user `gns3_src`}}",
          "ssh_username": "{{user `ssh_name`}}",
          "ssh_password": "{{user `ssh_pass`}}",
          "shutdown_timeout": "60m",
          "shutdown_command" : "echo {{user `ssh_name`}} | sudo -S shutdown -P now",
          "vmx_data_post":
          {
            "vhv.enable": "TRUE",
            "disk.enableUUID": "TRUE",
            "ethernet0.present": "TRUE",
            "ethernet0.startConnected": "TRUE",
            "ethernet0.connectionType": "hostonly",
            "ethernet0.addressType": "generated",
            "ethernet0.generatedAddressOffset": "0",
            "ethernet0.wakeOnPcktRcv": "FALSE",
            "ethernet0.pciSlotNumber": "32",
            "ethernet1.present": "TRUE",
            "ethernet1.startConnected": "TRUE",
            "ethernet1.connectionType": "nat",
            "ethernet1.addressType": "generated",
            "ethernet1.generatedAddressOffset": "10",
            "ethernet1.wakeOnPcktRcv": "FALSE",
            "ethernet1.pciSlotNumber": "33",
            "ethernet1.virtualDev": "e1000"
         },
         "skip_compaction": false
      },
      {
          "type": "virtualbox-ovf",
          "ssh_timeout": "20m",
          "ssh_handshake_attempts": "20",
          "vm_name" : "GNS3 VM",
          "headless": true,
          "source_path": "{{user `gns3_src`}}",
          "ssh_username": "{{user `ssh_name`}}",
          "ssh_password": "{{user `ssh_pass`}}",
          "shutdown_command" : "echo {{user `ssh_name`}} | sudo -S shutdown -P now",
          "shutdown_timeout": "60m",
          "format": "ova",
          "guest_additions_mode" : "disable",
          "vboxmanage" : [
             [
               "modifyvm",
               "{{.Name}}",
               "--nic1",
               "nat"
             ]
          ],
          "vboxmanage_post" : [
             [
               "modifyvm",
               "{{.Name}}",
               "--nic1",
               "hostonly"
             ],
             [
               "modifyvm",
               "{{.Name}}",
               "--nictype1",
               "82540EM"
             ],
             [
                "modifyvm",
                "{{.Name}}",
                "--hostonlyadapter1",
                "vboxnet0"
             ],
             [
                "modifyvm",
                "{{.Name}}",
                "--nic2",
                "nat"
             ],
             [
               "modifyvm",
               "{{.Name}}",
               "--nictype2",
               "82540EM"
             ]
          ]
      },
      {
         "type": "qemu",
         "vm_name" : "GNS3 VM",
         "qemu_binary": "qemu-system-aarch64",
         "disk_compression": true,
         "disk_image": true,
         "headless": true,
         "net_device": "virtio-net-pci",
         "iso_url" : "{{user `iso_url`}}",
         "iso_checksum" : "{{user `iso_checksum`}}",
         "iso_checksum_type": "{{user `iso_checksum_type`}}",
         "use_default_display": true,
         "http_directory": "http",
         "qemuargs": [
                ["-drive", "file=gns3vm-disk1.qcow2,if=virtio,format=qcow2,cache=none"],
                ["-drive", "file=gns3vm-disk2.qcow2,if=virtio,format=qcow2,cache=none"],
                ["-serial", "file:serial.out"],
                ["-machine", "virt,gic-version=3,accel=kvm"],
                ["-cpu", "max"],
                ["-smp", "4"],
                ["-m", "2048"],
                ["-bios", "/usr/share/qemu-efi-aarch64/QEMU_EFI.fd"],
                ["-boot", "strict=off"]
         ],
         "shutdown_command" : "echo {{user `ssh_name`}} | sudo -S shutdown -P now",
         "shutdown_timeout": "20m",
         "ssh_username" : "{{user `ssh_name`}}",
         "ssh_password" : "{{user `ssh_pass`}}",
         "ssh_timeout": "20m",
         "ssh_handshake_attempts": "20"
      }
   ]
}
